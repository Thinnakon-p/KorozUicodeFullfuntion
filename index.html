<?php
session_start();
?>

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <title>Koroz City - Posts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap" rel="stylesheet"/>
    <style>
        /* CSS เดิมทั้งหมด - ไม่เปลี่ยน */
        body { 
            font-family: 'Kanit', sans-serif; 
            background-color: #121212; 
            color: #f0f0f0; 
        }
        .posts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            padding: 20px 0;
            max-width: 1200px;
            margin: 0 auto;
        }
        .post {
            background-color: #1e1e1e;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            transition: all 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
            opacity: 0;
            transform: translateY(30px);
            cursor: pointer;
        }
        .post:nth-child(1) { animation: slideInUp 0.6s 0.1s ease forwards; }
        .post:nth-child(2) { animation: slideInUp 0.6s 0.2s ease forwards; }
        .post:nth-child(3) { animation: slideInUp 0.6s 0.3s ease forwards; }
        .post:nth-child(4) { animation: slideInUp 0.6s 0.4s ease forwards; }
        .post:nth-child(5) { animation: slideInUp 0.6s 0.5s ease forwards; }
        .post:nth-child(6) { animation: slideInUp 0.6s 0.6s ease forwards; }
        .post:nth-child(7) { animation: slideInUp 0.6s 0.7s ease forwards; }
        .post:nth-child(8) { animation: slideInUp 0.6s 0.8s ease forwards; }
        @keyframes slideInUp {
            0% { opacity: 0; transform: translateY(30px) scale(0.95); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        .post:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(185, 28, 28, 0.3);
        }
        .post-header { display: flex; align-items: center; padding: 16px; border-bottom: 1px solid #333; }
        .post-avatar { width: 48px; height: 48px; border-radius: 50%; margin-right: 12px; border: 2px solid #b91c1c; }
        .post-description { padding: 16px; color: #f0f0f0; line-height: 1.6; min-height: 80px; }
        .post-image { width: 100%; height: 200px; object-fit: cover; }
        .post-footer { padding: 12px 16px; font-size: 0.9em; color: #aaa; }
        .post-actions { display: flex; justify-content: center; padding: 12px 16px; background-color: #1a1a1a; }
        .action-btn { display: flex; align-items: center; gap: 8px; color: #b0b3b8; cursor: pointer; transition: all 0.3s; font-weight: 600; padding: 8px 16px; border-radius: 8px; width: 100%; justify-content: center; }
        .action-btn:hover:not(.disabled) { color: #b91c1c; background: rgba(185, 28, 28, 0.1); }
        .action-btn.disabled { color: #666; cursor: not-allowed; }
        .download-container { padding: 16px; text-align: center; }
        .download-btn { width: 100%; padding: 12px; background: linear-gradient(45deg, #ff5f6d, #ffc371); border: none; border-radius: 12px; color: #fff; font-weight: 700; cursor: pointer; transition: all 0.3s; }
        .download-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255, 95, 109, 0.4); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.9); z-index: 10000; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(8px); }
        .modal-content { background: #1e1e1e; border-radius: 12px; width: 90vw; max-width: 800px; height: 85vh; max-height: 85vh; overflow-y: auto; position: relative; box-shadow: 0 0 50px rgba(185, 28, 28, 0.5); }
        .close-btn { position: absolute; top: 15px; right: 15px; background: #b91c1c; border: none; width: 40px; height: 40px; border-radius: 50%; color: #fff; font-size: 20px; cursor: pointer; z-index: 10; transition: all 0.3s; }
        .close-btn:hover { background: #ef4444; transform: scale(1.1); }
        .modal-post { border-radius: 12px; height: 100%; }
        .modal-post .post-image { height: 300px; }
        .modal-post .post-description { min-height: 100px; font-size: 1.1em; padding: 20px; }
        .modal-post .download-btn { width: 250px; margin: 0 auto; }
        @media (max-width: 768px) { .posts-grid { grid-template-columns: repeat(2, 1fr); } .modal-content { width: 95vw; height: 90vh; } }
        @media (max-width: 480px) { .posts-grid { grid-template-columns: 1fr; } .modal-content { width: 98vw; height: 95vh; padding: 10px; } }
        .honeycomb { display: flex; flex-wrap: wrap; gap: 4px; width: 60px; margin: 40px auto; }
        .honeycomb div { width: 12px; height: 12px; background: #b91c1c; clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); animation: honeycomb 1s infinite alternate; }
        @keyframes honeycomb { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(1.2); opacity: 1; } }
        .Btn { width: 140px; height: 40px; border: none; border-radius: 10px; background: linear-gradient(to right,#000000,#777572,#9c9c9c,#ffffff,#c0bfbe,#727272); background-size: 250%; background-position: left; color: #ffd277; cursor: pointer; transition-duration: 1s; overflow: hidden; }
        .Btn::before { content: "Sign Up"; color: #fffffe; display: flex; align-items: center; justify-content: center; width: 97%; height: 90%; border-radius: 8px; background-color: rgba(0, 0, 0, 0.842); }
        .Btn:hover { background-position: right; }
    </style>
</head>
<body>
    <!-- NAV -->
    <nav class="fixed w-full z-30 top-0 bg-black bg-opacity-80 p-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <a class="text-2xl font-bold text-red-700" href="#">Koroz</a>
            <button class="Btn" onclick="window.location.href='login.php'">Sign Up</button>
        </div>
    </nav>
    
    <!-- MAIN -->
    <main class="pt-24 max-w-7xl mx-auto px-6">
        <section class="py-16 text-center">
            <h1 class="text-4xl font-bold mb-8">ยินดีต้อนรับสู่ Koroz City <span class="text-red-500">Guest</span></h1>
            <p class="text-lg mb-8">กรุณาล็อกอินเพื่อใช้งานฟีเจอร์ไลค์</p>
            
            <div id="loading" class="honeycomb">
                <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
            </div>
            
            <h2 class="text-3xl font-bold mb-8">โพสต์</h2>
            <div id="postsContainer" class="posts-grid"></div>
        </section>
    </main>

    <!-- MODAL -->
    <div id="modal" class="modal" onclick="closeModal(event)">
        <button class="close-btn" onclick="closeModal()">&times;</button>
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="modalPostContent"></div>
        </div>
    </div>

    <script>
        const isLoggedIn = false;

function renderPost(post, isModal = false) {
    const postElem = document.createElement('div');
    postElem.className = `post ${isModal ? 'modal-post' : ''}`;
    
    // ✅ แสดงชื่อโพสต์ + คำอธิบาย ชัดเจน
    const postTitle = post.title || 'ไม่มีชื่อ';
    const postDesc = post.description || 'ไม่มีคำอธิบาย';
    
    postElem.innerHTML = `
        <div class="post-header">
            <img src="${post.poster_avatar || 'assets/korox.webp'}" class="post-avatar" alt="Avatar" onerror="this.src='assets/korox.webp'">
            <div>
                <div class="font-bold text-red-500">${post.poster_name || 'Unknown'}</div>
                <div class="text-sm text-gray-400">${new Date(post.created_at).toLocaleString('th-TH')}</div>
            </div>
        </div>
        
        <!-- ✅ ชื่อโพสต์ (Title) -->
        <div class="px-4 pt-2 pb-1">
            <h3 class="font-bold text-lg text-white border-b border-red-500 pb-1">${postTitle}</h3>
        </div>
        
        <!-- ✅ คำอธิบาย (Description) -->
        <div class="post-description">
            <p>${postDesc}</p>
        </div>
        
        <!-- ✅ รูปภาพ -->
        ${post.post_image ? `<img src="${post.post_image}" class="post-image" alt="Post image" onerror="this.style.display='none'">` : ''}
        
        <!-- ✅ Likes -->
        <div class="post-footer">
            <span class="text-red-500 font-semibold">${post.likes_count || 0} <i class="fas fa-heart"></i></span>
        </div>
        
        <!-- ✅ Like Button -->
        <div class="post-actions">
            <div class="action-btn ${!isLoggedIn ? 'disabled' : ''}" onclick="${!isLoggedIn ? 'window.location.href=\'login.php\'' : ''}">
                <i class="far fa-thumbs-up"></i> 
                <span>${!isLoggedIn ? 'Login to Like' : 'Like'}</span>
            </div>
        </div>
        
        <!-- ✅ Download -->
        <div class="download-container">
            <button class="download-btn" onclick="window.open('${post.link}', '_blank'); event.stopPropagation();">
                <i class="fas fa-download mr-2"></i> Download
            </button>
        </div>
    `;

    if (!isModal) {
        postElem.addEventListener('click', (e) => {
            if (!e.target.closest('.action-btn') && !e.target.closest('.download-btn')) {
                openModal(post);
            }
        });
    }

    return postElem;
}

        function openModal(post) {
            document.getElementById('modalPostContent').innerHTML = '';
            document.getElementById('modalPostContent').appendChild(renderPost(post, true));
            document.getElementById('modal').style.display = 'flex';
        }

        function closeModal(event) {
            document.getElementById('modal').style.display = 'none';
        }

        // ✅ LOAD POSTS - แก้แล้ว!
        document.getElementById('loading').style.display = 'flex';
        console.log('Loading posts from fetch_posts.php...'); // Debug
        
        fetch("fetch_posts.php")  // ✅ เปลี่ยนจาก get-posts.php เป็น fetch_posts.php
            .then(response => {
                console.log('Response status:', response.status); // Debug
                if (!response.ok) throw new Error('HTTP ' + response.status);
                return response.json();
            })
            .then(data => {
                console.log('Posts data:', data); // Debug
                document.getElementById('loading').style.display = 'none';
                const container = document.getElementById('postsContainer');
                container.innerHTML = '';
                
                if (data.error) {
                    container.innerHTML = '<p class="text-red-500 text-center py-16 text-xl">Error: ' + data.error + '</p>';
                    return;
                }
                
                const posts = Array.isArray(data) ? data : [];
                if (posts.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-16">ไม่มีโพสต์</p>';
                    return;
                }
                
                posts.forEach((post, index) => {
                    const postElem = renderPost(post);
                    container.appendChild(postElem);
                });
            })
            .catch(error => {
                console.error('Fetch error:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('postsContainer').innerHTML = 
                    '<p class="text-red-500 text-center py-16 text-xl">โหลดโพสต์ไม่สำเร็จ: ' + error.message + '</p>';
            });

        // ESC KEY
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
    </script>
</body>
</html>